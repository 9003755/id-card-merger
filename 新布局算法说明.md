# 身份证PDF合并 - 新布局算法

## 🎯 算法目标

根据最新规范要求，实现以下功能：
1. ✅ **两张照片大小完全一致**
2. ✅ **两张照片之间留有缝隙** 
3. ✅ **自动调整图片大小确保不超出PDF范围**
4. ✅ **两张照片都处于PDF中间位置**

## 🧮 核心算法逻辑

### 1. **统一尺寸计算**
```typescript
// 关键思路：找到一个统一的尺寸，让两张图片都能适应
const frontAspectRatio = frontImage.width / frontImage.height;
const backAspectRatio = backImage.width / backImage.height;

// 方案1：基于可用宽度计算需要的高度
const widthBasedHeight1 = availableWidth / frontAspectRatio;
const widthBasedHeight2 = availableWidth / backAspectRatio;
const maxWidthBasedHeight = Math.max(widthBasedHeight1, widthBasedHeight2);

// 方案2：基于可用高度计算需要的宽度  
const heightBasedWidth1 = maxImageHeight * frontAspectRatio;
const heightBasedWidth2 = maxImageHeight * backAspectRatio;
const maxHeightBasedWidth = Math.max(heightBasedWidth1, heightBasedWidth2);
```

### 2. **智能方案选择**
```typescript
if (maxWidthBasedHeight <= maxImageHeight) {
    // 使用最大宽度，高度适应
    finalWidth = availableWidth;
    finalHeight = maxWidthBasedHeight;
} else if (maxHeightBasedWidth <= availableWidth) {
    // 使用最大高度，宽度适应
    finalWidth = maxHeightBasedWidth;
    finalHeight = maxImageHeight;
} else {
    // 两个方案都超限，选择更保守的缩放
    // ...缩放处理
}
```

### 3. **居中布局**
```typescript
// 水平居中
const imageX = margin + (availableWidth - imageWidth) / 2;

// 垂直分布：在各自区域内居中
const frontY = margin + (maxImageHeight - imageHeight) / 2;
const backY = margin + maxImageHeight + imageGap + (maxImageHeight - imageHeight) / 2;
```

## 📐 PDF布局结构

```
┌─────────────────────────────────────┐ ← A4纸 (210×297mm)
│  margin(20mm)                       │
│  ┌─────────────────────────────────┐ │ ← 可用区域 (170×267mm)
│  │                                 │ │
│  │     ┌─────────────────┐         │ │ ← 正面图片区域 (133.5mm高)
│  │     │   正面图片      │         │ │   (居中显示，统一尺寸)
│  │     │  (统一尺寸)     │         │ │
│  │     └─────────────────┘         │ │
│  │                                 │ │
│  │         gap(10mm)               │ │ ← 图片间隙
│  │                                 │ │
│  │     ┌─────────────────┐         │ │ ← 反面图片区域 (133.5mm高)
│  │     │   反面图片      │         │ │   (居中显示，相同尺寸)
│  │     │  (统一尺寸)     │         │ │
│  │     └─────────────────┘         │ │
│  │                                 │ │
│  └─────────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

## 🔍 算法特点

### ✅ **优势**
1. **绝对一致性**：两张图片使用完全相同的尺寸
2. **智能适应**：根据图片宽高比自动选择最优布局方案
3. **空间利用**：在保证不超出范围的前提下最大化图片尺寸
4. **完美居中**：水平和垂直方向都精确居中

### 📊 **测试场景**
| 场景 | 正面尺寸 | 反面尺寸 | 算法选择 | 结果 |
|------|----------|----------|----------|------|
| 横向身份证 | 1200×800 | 1500×1000 | 宽度优先 | 统一170×113.3mm |
| 竖向身份证 | 800×1200 | 1000×1500 | 高度优先 | 统一89×133.5mm |
| 混合比例 | 1200×800 | 1000×1500 | 缩放处理 | 统一适应尺寸 |

## 🧪 调试功能

### 使用方法
1. **上传两张图片**
2. **点击"🔍 分析图片尺寸"按钮**
3. **查看控制台详细输出**

### 调试输出示例
```
=== PDF布局模拟（统一尺寸算法）===
正面图片: {width: 1200, height: 800, aspectRatio: 1.5}
反面图片: {width: 1500, height: 1000, aspectRatio: 1.5}
PDF可用区域: {availableWidth: '170mm', maxImageHeight: '133.5mm'}

尺寸计算分析:
方案1 - 基于宽度: 需要高度 113.3mm (限制: 133.5mm)
方案2 - 基于高度: 需要宽度 200.3mm (限制: 170mm)
✅ 选择方案1：使用最大宽度，高度适应

📐 最终布局结果:
统一图片尺寸: 170.0mm × 113.3mm
图片宽高比: 1.500
正面图片位置: (20.0, 30.1)
反面图片位置: (20.0, 173.6)
图片间距: 10mm

✅ 布局验证：所有图片都在PDF边界内

🔍 一致性检查:
两张图片尺寸: 完全一致 ✅
两张图片位置: X坐标相同，Y坐标垂直分布 ✅
垂直间距: 30.1mm ✅
```

## 🎉 核心改进

### **与旧算法对比**
| 特性 | 旧算法 | 新算法 |
|------|--------|--------|
| 尺寸一致性 | 可能不一致 | **绝对一致** |
| 布局逻辑 | 复杂缩放计算 | **简洁统一算法** |
| 空间利用 | 保守 | **最优化** |
| 调试支持 | 基础 | **详细分析** |

### **解决的问题**
1. ❌ ~~图片大小不一致~~ → ✅ **完全一致**
2. ❌ ~~布局不够居中~~ → ✅ **精确居中**
3. ❌ ~~空间浪费~~ → ✅ **最大化利用**
4. ❌ ~~难以调试~~ → ✅ **详细分析**

## 🚀 使用指南

1. **立即测试**：http://localhost:5173
2. **上传您的两张身份证图片**
3. **点击调试按钮查看算法工作过程**
4. **生成PDF验证效果**

新算法确保您的身份证PDF布局完美、专业、一致！🎯