# Netlify部署准备工作记录

**记录时间**: 2025年8月27日 16:20  
**操作类型**: 部署准备与备份  
**目标平台**: Netlify  
**项目状态**: 开发完成，准备生产部署  

## 📋 当前项目状态备份

### 项目完整性检查
- ✅ 前端应用正常运行 (http://localhost:5173/)
- ✅ 后端服务正常运行 (http://localhost:3001/)
- ✅ OCR功能测试通过
- ✅ PDF生成功能正常
- ✅ 批量处理功能完整
- ✅ 所有代码已提交并备份

### 技术栈确认
- **前端**: React 19.1.1 + TypeScript 5.8.3 + Vite 7.1.2
- **后端**: Express 5.1.0 + Node.js ES模块
- **OCR服务**: 百度OCR API (已配置密钥)
- **构建工具**: Vite + TypeScript
- **部署目标**: Netlify (静态网站 + Serverless Functions)

### 当前文件结构快照
```
id-card-merger/
├── src/                     # 前端源码
│   ├── components/          # React组件
│   ├── utils/              # 工具函数
│   ├── types/              # TypeScript类型
│   └── App.tsx             # 主应用
├── server.js               # 当前后端服务
├── package.json            # 依赖配置
├── vite.config.ts          # Vite配置
├── tsconfig.json           # TypeScript配置
└── netlify.toml            # Netlify配置(需创建)
```

## 🎯 Netlify部署准备要求

### 1. 代码结构调整需求

#### A. 创建Netlify Functions
需要将`server.js`转换为Netlify Functions格式：

**目标结构**:
```
netlify/
└── functions/
    └── api.ts              # OCR API端点
```

#### B. 配置文件需求
- `netlify.toml` - Netlify部署配置
- 更新`package.json` - 添加构建脚本
- 环境变量配置 - API密钥安全管理

### 2. 依赖管理调整

#### 需要安装的Netlify专用依赖:
```bash
npm install @netlify/functions serverless-http
```

#### 当前依赖兼容性检查:
- ✅ express: v5.1.0 (需用serverless-http包装)
- ✅ cors: v2.8.5 (兼容)
- ✅ node-fetch: v3.3.2 (兼容)
- ✅ 所有前端依赖兼容Netlify

### 3. 环境变量迁移计划

#### 当前硬编码的配置:
```javascript
// server.js中的配置需要迁移到环境变量
const BAIDU_CONFIG = {
  apiKey: 'WYCtNFVBM4dh4eYvrI29Wsos',
  secretKey: 'qWwWkr8uU59TwSHQO0NpafeiqRtN8lTG',
  appId: '119868043'
};
```

#### 迁移到Netlify环境变量:
- `BAIDU_API_KEY`
- `BAIDU_SECRET_KEY` 
- `BAIDU_APP_ID`

## 🛠️ 具体准备步骤

### 步骤1: 备份当前状态
- [x] 代码已备份到`项目备份_2025-08-27_14-17-10/`
- [x] 文档已完整记录
- [x] 功能测试通过记录已保存

### 步骤2: 安装Netlify依赖
```bash
npm install @netlify/functions serverless-http
```

### 步骤3: 创建Netlify Function
将`server.js`内容转换为`netlify/functions/api.ts`

### 步骤4: 创建Netlify配置
创建`netlify.toml`配置文件

### 步骤5: 更新构建配置
修改`package.json`添加Netlify构建命令

### 步骤6: 环境变量配置
在Netlify控制台配置API密钥

### 步骤7: 测试部署
本地测试 → 预览部署 → 生产部署

## ⚠️ 风险评估与回滚计划

### 部署风险:
1. **API路由变更**: `/api/*` 路径可能需要调整
2. **CORS配置**: Netlify环境下的跨域设置
3. **函数超时**: 30秒执行限制可能影响OCR处理
4. **中国访问**: Netlify在中国访问不稳定

### 回滚方案:
1. **代码回滚**: 使用Git恢复到当前commit
2. **依赖回滚**: 从`package-lock.json`恢复依赖
3. **配置回滚**: 保留原始`server.js`作为备用
4. **服务回滚**: 继续使用本地Express服务器

### 回滚命令:
```bash
# 如果部署失败，执行以下命令回到当前状态
git stash  # 暂存修改
git reset --hard HEAD  # 回到当前状态
npm install  # 恢复依赖
npm run dev  # 启动本地开发
node server.js  # 启动后端服务
```

## 📝 部署成功验证清单

### 前端验证:
- [ ] 网站首页正常加载
- [ ] 三个模式(单个/批量/OCR)正常切换
- [ ] 文件上传功能正常
- [ ] 界面样式正确显示

### 后端验证:
- [ ] `/api/health` 健康检查通过
- [ ] `/api/test` API连接测试通过
- [ ] `/api/ocr` OCR识别功能正常
- [ ] `/api/network-diagnosis` 网络诊断正常

### 功能验证:
- [ ] 单个模式PDF生成正常
- [ ] 批量模式ZIP打包正常
- [ ] OCR识别准确率符合预期
- [ ] 错误处理机制正常工作

---

**备份状态**: ✅ 已完成  
**准备清单**: ✅ 已制定  
**风险评估**: ✅ 已完成  
**回滚方案**: ✅ 已准备  

**下一步**: 等待用户确认后开始执行部署准备步骤